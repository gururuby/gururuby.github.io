<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Gururuby.ru | Блог Ruby-разработчика]]></title>
  <link href="http://gururuby.ru/atom.xml" rel="self"/>
  <link href="http://gururuby.ru/"/>
  <updated>2016-01-30T13:08:32+03:00</updated>
  <id>http://gururuby.ru/</id>
  <author>
    <name><![CDATA[Gururuby.ru]]></name>
    <email><![CDATA[i@gururuby.ru]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Тестируем внешние сервисы легко!]]></title>
    <link href="http://gururuby.ru/blog/2016/01/29/stubbing-external-services/"/>
    <updated>2016-01-29T22:40:46+03:00</updated>
    <id>http://gururuby.ru/blog/2016/01/29/stubbing-external-services</id>
    <content type="html"><![CDATA[<p><img src="http://gururuby.ru/images/vcr.jpg">
В любом крупном проекте, так или иначе, но приходится сталкиваться с использованием внешних сервисов.
Это может быть шлюз для отправки SMS, или сервис для получения курсов валют. В этой статье я опишу
как тестировать их легко и приятно.</p>

<!-- more -->


<p>API социальных сетей, платежных систем, и прочее прочее. Сейчас редко крупный проект обходится без привязки к внешним сервисам.
Тестировать код, связанный со внешними сервисами не всегда легко, это издержки сети, медленное соединение. Лучше
изолировать эти тесты с помощью заглушек.</p>

<h3>Имитация сервиса на примере конвертера валют</h3>

<p>Допустим у нас есть некая система, которая использует внешний сервис <a href="http://fixer.io/">Fixer.io</a> для получения курсов валют, и преобразования
некой суммы в ту валюту, которую укажет клиент.</p>

<figure class='code'><figcaption><span>converter.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Converter</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;RUB&quot;</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@amount</span> <span class="o">=</span> <span class="n">amount</span>
</span><span class='line'>    <span class="vi">@target</span> <span class="o">=</span> <span class="n">target</span>
</span><span class='line'>    <span class="vi">@source</span> <span class="o">=</span> <span class="n">source</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">convert!</span>
</span><span class='line'>    <span class="n">body</span> <span class="o">=</span> <span class="n">get_exchange_rate_from_api</span>
</span><span class='line'>    <span class="n">rate</span> <span class="o">=</span> <span class="n">extract_exchange_rate</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@amount</span> <span class="o">*</span> <span class="n">rate</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">extract_exchange_rate</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'>    <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">[</span><span class="s2">&quot;rates&quot;</span><span class="o">][</span><span class="vi">@target</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get_exchange_rate_from_api</span>
</span><span class='line'>    <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="n">api_url</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">api_url</span>
</span><span class='line'>    <span class="s2">&quot;http://api.fixer.io/latest?symbols=</span><span class="si">#{</span><span class="vi">@target</span><span class="si">}</span><span class="s2">&amp;base=</span><span class="si">#{</span><span class="vi">@source</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Наш код прекрасно работает на production сервере. Но мы не хотим, чтобы при тестировании приложения, отправлялись реальные
запросы к сервису. Давайте посмотрим какие инструменты наиболее популярны для решения этой задачи.</p>

<h3>Webmock</h3>

<p>Webmock это библиотека для создания и использования заглушек HTTP запросов. Это довольно простой и удобный инструмент, и подходит
для использования в связке с Rspec, Minitest, Test::Unit</p>

<p>Настройка Webmock проста. На странице проекта есть <a href="https://github.com/bblimke/webmock">инструкция по установке</a>. Она сводится к установке gem, и прописыванию библиотеки в
<code>spec_helper.rb</code> или в <code>test_helper.rb</code></p>

<figure class='code'><figcaption><span>test_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;webmock/minitest&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>spec_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;webmock/rspec&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Давайте посмотрим как будет выглядеть тест на Rspec, написанный с использованием Webmock</p>

<figure class='code'><figcaption><span>converter_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Rspec</span><span class="o">.</span><span class="n">describe</span> <span class="no">Converter</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'> <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>     <span class="n">stub_request</span><span class="p">(</span><span class="ss">:get</span><span class="p">,</span> <span class="s2">&quot;http://api.fixer.io/latest?symbols=USD&amp;base=EUR&quot;</span><span class="p">)</span><span class="o">.</span>
</span><span class='line'>          <span class="n">to_return</span><span class="p">(</span><span class="ss">:body</span> <span class="o">=&gt;</span> <span class="sx">%Q(</span>
</span><span class='line'><span class="sx">    {</span>
</span><span class='line'><span class="sx">    &quot;base&quot;: &quot;EUR&quot;,</span>
</span><span class='line'><span class="sx">    &quot;date&quot;: &quot;2016-01-29&quot;,</span>
</span><span class='line'><span class="sx">    &quot;rates&quot;: {</span>
</span><span class='line'><span class="sx">    &quot;USD&quot;: 2.0</span>
</span><span class='line'><span class="sx">    }</span>
</span><span class='line'><span class="sx">    }</span>
</span><span class='line'><span class="sx">    )</span><span class="p">)</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="n">it</span> <span class="s1">&#39;should convert eur to usd&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="no">Converter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;EUR&quot;</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">convert!</span><span class="p">)</span><span class="o">.</span><span class="n">to_eq</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Все довольно просто. Теперь когда наш код в тесте будет обращаться по url <code>http://api.fixer.io/latest?symbols=USD&amp;base=EUR</code>
, вызов сервиса будет заглушаться, и вместо реального запроса мы получим то, что указали в <code>to_return</code>.</p>

<p>Webmock позволяет легко создавать заглушки для сервиса, но есть и подводные камни. Если вдруг ответ реального сервера поменялся, например
поменялось API, то мы не сможем отследить это изменение через тест.</p>

<h3>VCR</h3>

<p>Решить проблему, обозначенную выше помогает - <a href="https://github.com/vcr/vcr">VCR</a>. Его отличие от Webmock в том, что VCR
записывает реальный HTTP-ответ от сервиса и использует его потом изолированно в тестах. Запись производится в YAML файл.</p>

<p>Настройка и установка также простая. Установить gem, и добавить конфигурационные строчки в <code>test_helper.rb</code> или <code>spec_helper.rb</code></p>

<figure class='code'><figcaption><span>spec_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;vcr&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">VCR</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># Указываем где будем хранить наши кассеты )</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">cassette_library_dir</span> <span class="o">=</span> <span class="s2">&quot;fixtures/vcr_cassettes&quot;</span>
</span><span class='line'>  <span class="c1"># Интегрируемся с webmock </span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">hook_into</span> <span class="ss">:webmock</span> <span class="c1"># or :fakeweb</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Вот пример мини-теста с использованием VCR</p>

<figure class='code'><figcaption><span>converter_test.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ConverterTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">it_converts_eur_to_usd</span>
</span><span class='line'>    <span class="no">VCR</span><span class="o">.</span><span class="n">use_cassette</span><span class="p">(</span><span class="s2">&quot;eur_to_usd_conversion&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">assert_equals</span> <span class="mi">4</span><span class="p">,</span> <span class="no">Converter</span><span class="o">.</span><span class="n">convert!</span><span class="p">(</span><span class="mi">4</span><span class="o">.</span><span class="mi">3932</span><span class="p">,</span> <span class="s2">&quot;EUR&quot;</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Во время запуска этого теста, будет послан реальный запрос к сервису, а ответ записан в yml-файл c названием, которое было указано
как аргумент в <code>VCR.use_cassette</code>.</p>

<p>Вот так примерно будет выглядеть ответ, записанный в файл:</p>

<figure class='code'><figcaption><span>test/fixtures/vcr_cassettes/eur_to_usd_conversion.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">http_interactions</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">request</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">method</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">get</span>
</span><span class='line'>    <span class="l-Scalar-Plain">uri</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://api.fixer.io/latest?base=EUR&amp;symbols=USD</span>
</span><span class='line'>    <span class="l-Scalar-Plain">body</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">US-ASCII</span>
</span><span class='line'>      <span class="l-Scalar-Plain">string</span><span class="p-Indicator">:</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">headers</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">Accept-Encoding</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">gzip;q=1.0,deflate;q=0.6,identity;q=0.3</span>
</span><span class='line'>      <span class="l-Scalar-Plain">Accept</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;*/*&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">User-Agent</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Ruby</span>
</span><span class='line'>      <span class="l-Scalar-Plain">Host</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">api.fixer.io</span>
</span><span class='line'>  <span class="l-Scalar-Plain">response</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">status</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">code</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">200</span>
</span><span class='line'>      <span class="l-Scalar-Plain">message</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">OK</span>
</span><span class='line'>    <span class="l-Scalar-Plain">headers</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">Server</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nginx/1.4.6 (Ubuntu)</span>
</span><span class='line'>      <span class="l-Scalar-Plain">Date</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Fri, 29 Jan 2016 23:00:20 GMT</span>
</span><span class='line'>      <span class="l-Scalar-Plain">Content-Type</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">application/json</span>
</span><span class='line'>      <span class="l-Scalar-Plain">Content-Length</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;56&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">Connection</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">keep-alive</span>
</span><span class='line'>      <span class="l-Scalar-Plain">Status</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">200 OK</span>
</span><span class='line'>      <span class="l-Scalar-Plain">Last-Modified</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Wed, 28 Jan 2016 00:00:00 GMT</span>
</span><span class='line'>      <span class="l-Scalar-Plain">X-Content-Type-Options</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nosniff</span>
</span><span class='line'>    <span class="l-Scalar-Plain">body</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">UTF-8</span>
</span><span class='line'>      <span class="l-Scalar-Plain">string</span><span class="p-Indicator">:</span> <span class="s">&#39;{&quot;base&quot;:&quot;EUR&quot;,&quot;date&quot;:&quot;2016-01-29&quot;,&quot;rates&quot;:{&quot;USD&quot;:1.099}}&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">http_version</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">recorded_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Fri, 29 Jan 2016 23:00:20 GMT</span>
</span><span class='line'><span class="l-Scalar-Plain">recorded_with</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">VCR 3.0.0</span>
</span></code></pre></td></tr></table></div></figure>


<p>При последующем обращении к сервису, будет использоваться этот запрос, который записан в файл. Это довольно удобно, особенно
когда нужно использовать один и тот же запрос в разных местах.</p>

<h3>Внедрение зависимости (Dependency Injection)</h3>

<p>Еще один из способов, состоит во внедрении паттерна проектирования <a href="https://ru.wikipedia.org/wiki/%D0%92%D0%BD%D0%B5%D0%B4%D1%80%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B7%D0%B0%D0%B2%D0%B8%D1%81%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8">Dependency Injection</a>.
Посмотрим на примере нашего конвертера, как можно использовать его.</p>

<figure class='code'><figcaption><span>converter.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Converter</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;EUR&quot;</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;USD&quot;</span><span class="p">,</span> <span class="n">api</span> <span class="o">=</span> <span class="no">FixerAPI</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@amount</span> <span class="o">=</span> <span class="n">amount</span>
</span><span class='line'>    <span class="vi">@target</span> <span class="o">=</span> <span class="n">target</span>
</span><span class='line'>    <span class="vi">@source</span> <span class="o">=</span> <span class="n">source</span>
</span><span class='line'>    <span class="vi">@api</span>    <span class="o">=</span> <span class="n">api</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">convert!</span>
</span><span class='line'>    <span class="n">rate</span> <span class="o">=</span> <span class="vi">@api</span><span class="o">.</span><span class="n">get_exhange_rate</span><span class="p">(</span><span class="ss">source</span><span class="p">:</span> <span class="vi">@source</span><span class="p">,</span> <span class="ss">target</span><span class="p">:</span> <span class="vi">@target</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@amount</span> <span class="o">*</span> <span class="n">rate</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Итак, мы внедрили в конструктор класса Converter, FixerAPI класс, который представляет собой обертку для работы с сервисом Fixer.
Вот так выглядит наш FixerAPI класс</p>

<figure class='code'><figcaption><span>fixer_api.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FixerAPI</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_exchange_rate</span><span class="p">(</span><span class="ss">source</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="ss">target</span><span class="p">:</span> <span class="n">target</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">new</span><span class="o">.</span><span class="n">get_exhange_rate</span><span class="p">(</span><span class="ss">source</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="ss">target</span><span class="p">:</span> <span class="n">target</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get_exchange_rate</span><span class="p">(</span><span class="ss">source</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="ss">target</span><span class="p">:</span> <span class="n">target</span><span class="p">)</span>
</span><span class='line'>    <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="n">api_url</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
</span><span class='line'>    <span class="n">body</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>    <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">[</span><span class="s2">&quot;rates&quot;</span><span class="o">][</span><span class="n">target</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">api_url</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span><span class='line'>    <span class="s2">&quot;http://api.fixer.io/latest?symbols=</span><span class="si">#{</span><span class="n">target</span><span class="si">}</span><span class="s2">&amp;base=</span><span class="si">#{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Мы вынесли работу с внешним сервисом в отдельный класс, и можем его включать в любом месте где захотим. И в этом состоит суть
внедрения зависимости. Так как код стал изолирован, то и тестировать его можно, заменив например FixerAPI каким-нибудь FakeAPI.</p>

<figure class='code'><figcaption><span>converter_test.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FakeAPI</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_exchange_rate</span><span class="p">(</span><span class="ss">source</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="ss">target</span><span class="p">:</span> <span class="n">target</span><span class="p">)</span>
</span><span class='line'>    <span class="mi">2</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ConverterTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">it_converts_eur_to_usd</span>
</span><span class='line'>    <span class="n">assert_equals</span> <span class="mi">4</span><span class="p">,</span> <span class="no">Converter</span><span class="o">.</span><span class="n">convert!</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;EUR&quot;</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">,</span> <span class="no">FakeAPI</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Написать свой тестовый сервис</h3>

<p>Я не буду долго рассматривать этот способ, так как считаю его очень сложным. Но он имеет место быть.
Если коротко, то мы можем написать тестовый сервер, который будет работать например на <a href="https://nathanhoad.net/how-to-return-json-from-sinatra">Sinatra</a>. Он будет возвращать нам нужные данные.
Их мы и будем использовать в наших тестах.</p>

<figure class='code'><figcaption><span>fixer_server.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">get</span> <span class="s1">&#39;/latest&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content_type</span> <span class="ss">:json</span>
</span><span class='line'>  <span class="p">{</span> <span class="ss">base</span><span class="p">:</span> <span class="s2">&quot;EUR&quot;</span><span class="p">,</span> <span class="ss">date</span><span class="p">:</span> <span class="s2">&quot;2015-12-15&quot;</span><span class="p">,</span> <span class="ss">rates</span><span class="p">:</span> <span class="p">{</span> <span class="ss">usd</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">099</span> <span class="p">}</span> <span class="p">}</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Заключение</h3>

<p>Проблема вполне решаема, разными способами, но лично я остановился бы на VCR. Но конечно нужно смотреть еще
на целесообразность использования того или инструмента для облегчения тестирования внешних сервисов.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[С наступающим Новым 2016 годом!]]></title>
    <link href="http://gururuby.ru/blog/2015/12/30/happy_new_year_2016/"/>
    <updated>2015-12-30T00:00:00+03:00</updated>
    <id>http://gururuby.ru/blog/2015/12/30/happy_new_year_2016</id>
    <content type="html"><![CDATA[<p><img src="http://gururuby.ru/images/happy_new_year.jpg">
Поздравляю всех с наступающим 2016 годом! Добавим снежка, хотя бы виртуального )</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">ruby</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;def a;10.times{puts &quot; &quot;*rand(79)+&quot;*&quot;};end;99.times{a;puts &quot; &quot;*34+&quot;Happy New Year 2016&quot;;a;sleep 0.1;puts &quot;\e[2J&quot;}&#39;</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Простой чат с помощью ActionCable]]></title>
    <link href="http://gururuby.ru/blog/2015/12/18/simple-chat-via-action-cable/"/>
    <updated>2015-12-18T23:10:01+03:00</updated>
    <id>http://gururuby.ru/blog/2015/12/18/simple-chat-via-action-cable</id>
    <content type="html"><![CDATA[<p><img src="http://gururuby.ru/images/action_cable.png">
ActionCable, который ожидается в Rails 5, наконец на этой неделе был <a href="https://github.com/rails/rails/pull/22585">замержен</a> в мастер ветку Rails.
Давайте создадим простой чат на его основе.</p>

<!-- more -->


<p>Если вы не знаете, что такое ActionCable, то это библиотека, которая позволяет интегрировать WebSocket-ы c вашим Rails-приложением
Т.е мы имеем необходимый инструмент как на стороне клиента, так и на стороне сервера.</p>

<p>Итак, нам понадобится:</p>

<ul>
<li>Установленный Redis (для пользователей Ubuntu достаточно одной команды <code>sudo apt-get install redis-server</code>)</li>
<li>Rails 4.2 +</li>
</ul>


<h3>Создаем костяк проекта</h3>

<p>Назовем его chat, пропускаем установку gems, с помощью опции -B</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rails new chat -B
</span></code></pre></td></tr></table></div></figure>


<p>Теперь о необходимых гемах для работы нашего чата, нам понадобится:</p>

<ul>
<li>Сервер приложения - <a href="https://github.com/puma/puma">Puma</a>. Webrick тут не подходит так как ActionCable использует отдельный процесс нашего App сервера, и
поэтому нам нужен многопоточный сервер Puma или <a href="https://github.com/macournoyer/thin/">Thin</a></li>
<li>Шаблонизатор <a href="https://github.com/slim-template/slim-rails">slim</a> (просто привычка работать именно с ним)</li>
<li><a href="https://github.com/rails/actioncable">ActionCable</a></li>
</ul>


<p>Ваш Gemfile должен выглядеть примерно вот так:</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;4.2.5&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 5.0&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.3.0&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 4.1.0&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;turbolinks&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;jbuilder&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 2.0&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;sdoc&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 0.4.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:doc</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;actioncable&#39;</span><span class="p">,</span> <span class="ss">github</span><span class="p">:</span> <span class="s1">&#39;rails/actioncable&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;slim-rails&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;puma&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;byebug&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;web-console&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 2.0&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;spring&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Выполняем установку gems, <code>bundle install</code></p>

<h3>Структура проекта</h3>

<p>В нашем проекте будут контроллеры:</p>

<ul>
<li>MessagesController - будет отвечать за вывод сообщений и их создание</li>
<li>SessionsController - в нем мы создадим простую cookie-аутентификацию для пользователя</li>
</ul>


<p>При создании контроллеров будем использовать дополнительные опции, &ndash;no-helper и &ndash;no-assets,
чтобы не &ldquo;плодить&rdquo; лишние файлы.</p>

<h3>Контроллеры и маршруты</h3>

<p>Создаем контроллер Sessions</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rails g controller Sessions --no-helper --no-assets
</span></code></pre></td></tr></table></div></figure>


<p>Добавляем create action</p>

<figure class='code'><figcaption><span>app/controllers/sessions_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:username</span><span class="o">]</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">messages_path</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Создаем контроллер Messages</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rails g controller Messages --no-helper --no-assets
</span></code></pre></td></tr></table></div></figure>


<p>Action для index не обязателен, мы его опустим, создадим action create</p>

<figure class='code'><figcaption><span>app/controllers/messages_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MessagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="n">head</span> <span class="ss">:ok</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>В нем мы возвращаем заголовок <code>:ok</code> для ajax запроса.
Теперь пропишем маршруты для наших контроллеров в <code>routes.rb</code></p>

<figure class='code'><figcaption><span>app/config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:messages</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:create</span><span class="o">]</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">root</span> <span class="s1">&#39;sessions#new&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Корень нашего чата будет вести на логин пользователя</p>

<h3>Создаем View</h3>

<p>Для начала создадим страничку <code>new</code> для <code>SessionsController</code>, в которой будет простая форма с одним инпутом</p>

<figure class='code'><figcaption><span>app/views/sessions/new.html.slim</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='slim'><span class='line'><span class="p">=</span> <span class="n">form_for</span> <span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">sessions_path</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">form</span><span class="o">.</span><span class="n">label</span> <span class="ss">:username</span><span class="p">,</span> <span class="s1">&#39;Ваш никнейм&#39;</span>
</span><span class='line'>  <span class="nt">br</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">form</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:username</span>
</span><span class='line'>  <span class="nt">br</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">form</span><span class="o">.</span><span class="n">submit</span> <span class="s1">&#39;Войти в чат&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Теперь создадим страницу на которой будут выводиться все сообщения и в ней будет находиться форма с созданием нового сообщения</p>

<figure class='code'><figcaption><span>app/views/messages/index.html.slim</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='slim'><span class='line'><span class="nt">p</span>
</span><span class='line'>  | Вы вошли как
</span><span class='line'>  &#39;
</span><span class='line'>  <span class="nt">b</span> <span class="si">#{</span><span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span><span class="si">}</span>
</span><span class='line'>
</span><span class='line'><span class="nf">#messages</span>
</span><span class='line'><span class="nt">br</span>
</span><span class='line'>
</span><span class='line'><span class="p">=</span> <span class="n">form_for</span> <span class="ss">:message</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">messages_path</span><span class="p">,</span> <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;messages-form&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">form</span><span class="o">.</span><span class="n">label</span> <span class="ss">:body</span><span class="p">,</span> <span class="s1">&#39;Введите сообщение:&#39;</span>
</span><span class='line'>  <span class="nt">br</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">form</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:body</span>
</span><span class='line'>  <span class="nt">br</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">form</span><span class="o">.</span><span class="n">submit</span> <span class="s1">&#39;Отправить сообщение&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Здесь мы выведем имя залогинившегося пользователя, и создадим контейнер для сообщений <code>#messages</code></p>

<h3>Настройка ActionCable(backend)</h3>

<p>Для работы с ActionCable необходимо создать 2 класса <code>Connection</code> и <code>Channel</code>
Создадим их в папке <code>app/channels/application_cable</code>
Прописывать <code>channels</code> в autoloads не нужно, Rails подгрузит их по умолчанию</p>

<figure class='code'><figcaption><span>app/channels/application_cable/connection.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ApplicationCable</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Connection</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">Connection</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/channels/application_cable/channel.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ApplicationCable</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Channel</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">Channel</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Настройка Redis</h3>

<p>ActionCable использует Redis, добавим конфигурационный файл в <code>config/redis/cable.yml</code>.
Настройки довольно стандартные для Redis.</p>

<figure class='code'><figcaption><span>config/redis/cable.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="nl">&amp;default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">redis://localhost:6379</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">6379</span>
</span><span class='line'>  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>  <span class="l-Scalar-Plain">inline</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span> <span class="nv">*default</span>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span> <span class="nv">*default</span>
</span></code></pre></td></tr></table></div></figure>


<p>Так как ActionCable использует отдельный процесс, то создадим rackup файл с конфигурацией <code>cable/config.ru</code></p>

<figure class='code'><figcaption><span>cable/config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../../config/environment&#39;</span><span class="p">,</span>  <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">eager_load!</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;action_cable/process/logging&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">run</span> <span class="no">ActionCable</span><span class="o">.</span><span class="n">server</span>
</span></code></pre></td></tr></table></div></figure>


<p>Для удобства запуска нашего ActionCable сервера, давайте добавим sh скрипт в папку <code>bin</code> и назовем его <code>cable</code></p>

<figure class='code'><figcaption><span>bin/cable</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># /bin/bash</span>
</span><span class='line'>bundle <span class="nb">exec </span>puma -p <span class="m">28080</span> cable/config.ru
</span></code></pre></td></tr></table></div></figure>


<p>Не забываем поставить этому файлу права на исполнение <code>chmod +x bin/cable</code></p>

<p>Теперь создадим <code>MessagesChannel</code>, ответственный за подписку на стрим</p>

<figure class='code'><figcaption><span>app/channels/messages_channel.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MessagesChannel</span> <span class="o">&lt;</span> <span class="no">ApplicationCable</span><span class="o">::</span><span class="no">Channel</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">subscribed</span>
</span><span class='line'>    <span class="n">stream_from</span> <span class="s1">&#39;messages&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Далее изменим наш action <code>create</code> в MessagesController, добавим функционал по отсылке сообщений</p>

<figure class='code'><figcaption><span>app/controllers/messages_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MessagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="no">ActionCable</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">broadcast</span> <span class="s1">&#39;messages&#39;</span><span class="p">,</span>
</span><span class='line'>                                 <span class="ss">message</span><span class="p">:</span> <span class="n">message_params</span><span class="o">[</span><span class="ss">:body</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                                 <span class="ss">username</span><span class="p">:</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span>
</span><span class='line'>    <span class="n">head</span> <span class="ss">:ok</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">message_params</span>
</span><span class='line'>    <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:message</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:body</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Настройка client-side</h3>

<p>Создадим папку <code>channels</code> в <code>app/assets/javascripts</code>.
Сначала необходимо создать соединение с нашим ActionCable сервером, создаем <code>index.coffee</code></p>

<figure class='code'><figcaption><span>app/assets/javascripts/channels/index.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='coffee'><span class='line'><span class="c1">#= require cable</span>
</span><span class='line'><span class="c1">#= require_self</span>
</span><span class='line'><span class="c1">#= require_tree .</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@App = </span><span class="p">{}</span>
</span><span class='line'><span class="nv">App.cable = </span><span class="nx">Cable</span><span class="p">.</span><span class="nx">createConsumer</span> <span class="s">&#39;ws://127.0.0.1:28080&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Теперь подпишемся на <code>MessagesChannel</code>, создаем <code>messages.coffee</code></p>

<figure class='code'><figcaption><span>app/assets/javascripts/channels/messages.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='coffee'><span class='line'><span class="nv">App.messages = </span><span class="nx">App</span><span class="p">.</span><span class="nx">cable</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span> <span class="s">&#39;MessagesChannel&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">received: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#messages&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">@renderMessage</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">renderMessage: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>    <span class="s">&quot;&lt;p&gt;&lt;b&gt;[</span><span class="si">#{</span><span class="nx">data</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span><span class="s">]:&lt;/b&gt; </span><span class="si">#{</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&lt;/p&gt;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Здесь в функции <code>received</code> мы получаем данные и вставляем отрендеренные сообщения в <code>#messages</code> контейнер</p>

<p>Теперь добавим наш js(<code>//= require channels</code>) в <code>application.js</code></p>

<figure class='code'><figcaption><span>app/assets/javascripts/application.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//= require jquery</span>
</span><span class='line'><span class="c1">//= require jquery_ujs</span>
</span><span class='line'><span class="c1">//= require turbolinks</span>
</span><span class='line'><span class="c1">//= require channels</span>
</span><span class='line'><span class="c1">//= require_tree .</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Наш чат готов!</h3>

<p>Запускаем наше rails приложение <code>rails s</code>, потом запускаем <code>./bin/cable</code>. Открываем либо два браузера, либо
запускаем вкладку в режиме инкогнито, переходим на <a href="http://localhost:3000">http://localhost:3000</a> и проверяем работу чата.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Что нового в Ruby 2.3?]]></title>
    <link href="http://gururuby.ru/blog/2015/12/16/whats_new_in_ruby_2_3/"/>
    <updated>2015-12-16T19:48:43+03:00</updated>
    <id>http://gururuby.ru/blog/2015/12/16/whats_new_in_ruby_2_3</id>
    <content type="html"><![CDATA[<p>Совсем скоро выйдет релиз Ruby 2.3.0, а пока доступен пререлиз под номером 1. Давайте посмотрим что новенького появилось.</p>

<!-- more -->


<p>Ставим ruby 2.3.0-preview1 через <a href="https://rvm.io/rvm/install/">rvm</a>, либо <a href="https://github.com/rbenv/rbenv#installation">rbenv</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># RVM</span>
</span><span class='line'>rvm install 2.3.0-preview1
</span><span class='line'>
</span><span class='line'><span class="c"># Rbenv</span>
</span><span class='line'>brew upgrade ruby-build --HEAD
</span><span class='line'>rbenv install 2.3.0-preview1
</span></code></pre></td></tr></table></div></figure>


<h3>~ Safe navigation operator ~</h3>

<p>Появился новый оператор - <code>&amp;.</code>. В Ruby on Rails есть замечательный метод <a href="http://apidock.com/rails/Object/try">try!</a>, так вот этот оператор
имеет схожую функциональность. Он выполняет проверку на nil до вызова метода у обьекта и возвращает его в случае если
сам nil, в противном случае вызывается метод после оператора.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Ruby &lt;= 2.2</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;User Admin&quot;</span> <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Ruby 2.3</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;User Admin&quot;</span> <span class="k">if</span> <span class="n">user</span><span class="o">&amp;.</span><span class="n">admin?</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Important</span>
</span><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'><span class="n">user</span><span class="o">&amp;.</span><span class="n">admin?</span> <span class="c1"># raise NoMethodError</span>
</span></code></pre></td></tr></table></div></figure>


<p>Но будьте внимательны, если <code>user</code> у вас будет например <code>false</code>, то вы получите <code>NoMethodError</code></p>

<h3>~ Frozen string literals ~</h3>

<p>До Ruby 2.2 строки были изменяемые, т.е мы могли взять и сделать что-то подобное <code>str[1] = 'a'</code>. Если нам было необходимо
запретить изменение строки, то с помощью метода <code>#freeze</code> это прекрасно получалось</p>

<p>Планируется использование <a href="https://bugs.ruby-lang.org/issues/11473">неизменных строк по умолчанию в Ruby 3.0</a>, разработчики хотят увеличить производительность языка,
уменьшив количество обьектов в памяти. В версии 2.3 можно включить этот режим, для этого в начало
файла нужно поместить комментарий <code># frozen_string_literal: true</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># frozen_string_literal: true</span>
</span><span class='line'>
</span><span class='line'><span class="n">str</span> <span class="o">=</span> <span class="s1">&#39;cat&#39;</span>
</span><span class='line'><span class="n">str</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># frozen.rb:5:in `[]=&#39;: can&#39;t modify frozen String (RuntimeError)</span>
</span><span class='line'><span class="c1">#   from frozen.rb:5:in `&lt;main&gt;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>~ Array#dig и Hash#dig ~</h3>

<p>Небольшие дополнения к стандартным библиотекам, которые позволяют выполнять такие вещи:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">list</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>  <span class="o">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="o">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="o">[</span> <span class="o">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="o">]</span> <span class="o">]</span>
</span><span class='line'><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">list</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>    <span class="c1">#=&gt; 9</span>
</span><span class='line'><span class="n">list</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#=&gt; 17</span>
</span><span class='line'><span class="n">list</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>    <span class="c1">#=&gt; nil</span>
</span><span class='line'><span class="n">list</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>    <span class="c1">#=&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">a</span><span class="p">:</span> <span class="p">{</span> <span class="ss">x</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span> <span class="ss">y</span><span class="p">:</span> <span class="mi">29</span> <span class="p">},</span>
</span><span class='line'>  <span class="ss">b</span><span class="p">:</span> <span class="p">{</span> <span class="ss">x</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="ss">z</span><span class="p">:</span> <span class="mi">37</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">dict</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="ss">:a</span><span class="p">,</span> <span class="ss">:x</span><span class="p">)</span> <span class="c1">#=&gt; 23</span>
</span><span class='line'><span class="n">dict</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="ss">:b</span><span class="p">,</span> <span class="ss">:z</span><span class="p">)</span> <span class="c1">#=&gt; 37</span>
</span><span class='line'><span class="n">dict</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="ss">:b</span><span class="p">,</span> <span class="ss">:y</span><span class="p">)</span> <span class="c1">#=&gt; nil</span>
</span><span class='line'><span class="n">dict</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="ss">:c</span><span class="p">,</span> <span class="ss">:x</span><span class="p">)</span> <span class="c1">#=&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>


<h3>~ Did you mean? ~</h3>

<p>Появилась удобная вещь, в виде подсказки, которая предлагает вам варианты правильного вызова метода, если вы вдруг опечатались</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">preview1</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="s2">&quot;string&quot;</span><span class="o">.</span><span class="n">downcaze</span>
</span><span class='line'>
</span><span class='line'><span class="ss">NoMethodError</span><span class="p">:</span> <span class="n">undefined</span> <span class="nb">method</span> <span class="sb">`downcaze&#39; for &quot;string&quot;:String</span>
</span><span class='line'><span class="sb">Did you mean?  downcase</span>
</span><span class='line'><span class="sb">               downcase!</span>
</span></code></pre></td></tr></table></div></figure>


<h3>~ Сравнение Hash ~</h3>

<p>Теперь можно сравнивать hash. Вот таким образом</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span> <span class="ss">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">y</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="o">&gt;=</span> <span class="p">{</span> <span class="ss">x</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="c1">#=&gt; true</span>
</span><span class='line'><span class="p">{</span> <span class="ss">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">y</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="o">&gt;=</span> <span class="p">{</span> <span class="ss">x</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="c1">#=&gt; false</span>
</span><span class='line'><span class="p">{</span> <span class="ss">x</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="o">&gt;=</span> <span class="p">{</span> <span class="ss">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">y</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="c1">#=&gt; false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Также можно применять и другие операторы сравнения, более подробно <a href="http://olivierlacan.com/posts/hash-comparison-in-ruby-2-3/">здесь</a></p>

<h3>~ Hash#to_proc ~</h3>

<p>Hash можно преобразовать в proc обьект, причем вызвав у proc ключ из Hash вы получите значение</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">foo</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">bar</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">baz</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</span><span class='line'><span class="nb">p</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">to_proc</span>
</span><span class='line'>
</span><span class='line'><span class="nb">p</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span>  <span class="c1">#=&gt; 1</span>
</span><span class='line'><span class="nb">p</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="ss">:bar</span><span class="p">)</span>  <span class="c1">#=&gt; 2</span>
</span><span class='line'><span class="nb">p</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="ss">:quux</span><span class="p">)</span> <span class="c1">#=&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>Иногда приходится для получения определенных значений из Hash использовать сложную конструкцию, с использованием <code>&amp;</code>
это немного упрощается</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">foo</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">bar</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">baz</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># bad:</span>
</span><span class='line'><span class="o">[</span><span class="ss">:foo</span><span class="p">,</span> <span class="ss">:bar</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="p">}</span> <span class="c1">#=&gt; [1, 2]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># good:</span>
</span><span class='line'><span class="o">[</span><span class="ss">:foo</span><span class="p">,</span> <span class="ss">:bar</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span> <span class="c1">#=&gt; [1, 2]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>~ Hash#fetch_values ~</h3>

<p>Новый метод похож по своей функциональности на <code>Hash#values_at</code>. Он позволяет получить значения по списку ключей.
Отличие <code>fetch_values</code> в том, что если ключа не найдется, то будет брошен exception <code>KeyError</code>, вместо возвращения <code>nil</code>, как это
реализовано в <code>values_at</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">foo</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">bar</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">baz</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">fetch_values</span><span class="p">(</span><span class="ss">:foo</span><span class="p">,</span> <span class="ss">:bar</span><span class="p">)</span> <span class="c1">#=&gt; [1, 2]</span>
</span><span class='line'>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="ss">:foo</span><span class="p">,</span> <span class="ss">:quux</span><span class="p">)</span>    <span class="c1">#=&gt; [1, nil]</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">fetch_values</span><span class="p">(</span><span class="ss">:foo</span><span class="p">,</span> <span class="ss">:quux</span><span class="p">)</span> <span class="c1">#=&gt; raise KeyError</span>
</span></code></pre></td></tr></table></div></figure>


<h3>~ Enumerable#grep_v ~</h3>

<p>Если вы знакомы с утилитой grep в linux системах, то в случае если мы применим опцию <code>-v</code> в вызове этой консольной утилиты,
то в результате выполнения этой команды <code>print "test" | grep t test -v</code> мы ничего не получим на выходе. Эта опция позволяет вывести то что не подошло,
т.е. она противоположна <code>grep</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">list</span> <span class="o">=</span> <span class="sx">%w(foo bar baz)</span>
</span><span class='line'>
</span><span class='line'><span class="n">list</span><span class="o">.</span><span class="n">grep_v</span><span class="p">(</span><span class="sr">/ba/</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [&#39;foo&#39;]</span>
</span><span class='line'>
</span><span class='line'><span class="n">list</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="sr">/ba/</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [&#39;bar&#39;, &#39;baz&#39;]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>~ Numeric#positive? и #negative? ~</h3>

<p>Добавилось несколько методов из Rails. Названия интуитивно понятны, можно обойтись без примеров</p>

<h2>Ссылки</h2>

<p><a href="https://www.ruby-lang.org/en/news/2015/11/11/ruby-2-3-0-preview1-released/">https://www.ruby-lang.org/en/news/2015/11/11/ruby-2-3-0-preview1-released/</a></p>
]]></content>
  </entry>
  
</feed>
